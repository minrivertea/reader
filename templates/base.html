{% load django_static %}

<!DOCTYPE html>
<html lang="en">
<head>

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
	<meta content="en-gb" http-equiv="Content-Language" />
	<meta content="{% block metadescription %}{% endblock %}" name="description" />
	
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="generator" content="Django - http://www.djangoproject.com" />
	<meta name="DC.format" content="text/html" />
	<meta name="DC.type" content="Django Site" />
	<meta name="robots" content="ALL" />
	
	<title>{% block pagetitle %}Chinese Dictionary and Learning Tools{% endblock %} | {{ site_name }}</title>	
	<style type="text/css">
	   {% include 'static/styles.txt' %}
	</style>
	
	<link rel='shortcut icon' href="{% staticfile '/images/favicon.ico' %}" type="image/x-icon" />
	
	<script type="text/javascript">
	   {% include 'static/jquery-1.8.2.min.js' %}
	</script>
	
	<script type="text/javascript">
	   {% include 'static/jquery.pjax.js' %}
	</script>
	
	{% block extracss %}{% endblock %}


</head>

<body class="font1{% if show_sidebar %} sidebar{% endif %}">

    <div id="header" class="{% if request.path == '/' %}home{% endif %}">
       <div id="header-inner" class="centred">
        <a href="/" id="logo" data-ajax>{{ sitename }}</a>
        
        <a href="{% url 'page' 'about' %}" title="about" data-ajax>about</a>
        <a href="{% url 'page' 'help' %}" title="help" data-ajax>help</a>
        {% if user.is_authenticated %}
        <a href="{% url 'user' %}">your account ({{ user.email }})</a>
        {% else %}
        <a href="{% url 'auth_login' %}" data-ajax>login</a> 
        <a href="{% url 'registration_register' %}">register</a>
        {% endif %}
        
        
            
        <form id="search" data-pjax action="{% url 'search' %}" method="post" class="">
            {% csrf_token %}
            <label for="id_char">Search for a Chinese word</label>
            <input id="id_char" class="clearMeFocus empty" title="Search for a Chinese word" name="char" value="" autofocus="autofocus" placeholder="Search for a Chinese word" >
            <input type="submit" value="Go" id="submit" class="submit button"/>
        </form>
      </div>
    </div>
        
    <div id="editable"></div>
    
    <a href="#" id="sidebar_toggle" class="{% if show_sidebar %}open{% endif %}">{% if show_sidebar %}Hide{% else %}Show{% endif %} wordlist</a>
    <div id="sidebar">
        {% include 'users/user_vocab_snippet.html' %}
    </div>
        
    <img id="loading" src="/images/loading.gif"/>
    
    <div id="container"> 
        {% block content %}{% endblock %}        
    </div>
    
	<script type="text/javascript">

		$(document).ready( function() {
            
            /// TOGGLES THE SIDEBAR
            $('#sidebar_toggle').click( function() {
                $('body').toggleClass('sidebar');
                var url = '';
                if ($(this).hasClass('open')) {
                    $(this).removeClass('open');
                    $(this).text('Show wordlist');
                    url = "{% url 'update_user_preferences' %}" + "?show_sidebar=False";
                } else {
                    url = "{% url 'update_user_preferences' %}" + "?show_sidebar=True";
                    $(this).addClass('open');
                    $(this).text('Hide wordlist');
                }
                
                $.ajax({
                    url: url,
                    success: function() {
                        /// nothing
                    }    
                });
                return false;
            });
            
            /// IF THIS IS THE HOMEPAGE, GIVE THE HEADER THE 'HOME' CLASS
            function checkHeader() {
            	if (window.location.pathname == '/') {
                    $('#header').addClass('home');  
            	} else {
            	    $('#header').removeClass('home');  
            	}
            }
            
                 
            /// BINDS THE SEARCH FORM TO PJAX        
            $(document).on('submit', '#header form[data-pjax]', function(event) {
                              
               if ($('#id_char').val() == '') {
                    /// HANDLES AN EMPTY SEARCH
                    var url = '/search/';
                    $.pjax({url: url, container: '#container'});
                    
               } else {               
                   /// CONVERT THE FORM INTO A GET REQUEST 
                   var string = $('#id_char').val().split(' ').join('_')
                   var url = '/search/' + string + '/';  
                   $.pjax({url: url, container: '#container'});
               };
               
               /// ADD THIS WORD TO THE WORDLIST?
               
               return false;

            });
              
             
                        
            /// SHOWS THE LOADING SPINNER
            $(document).on('pjax:send', function() {
              $('#container').fadeOut(150);
              $('#loading').show();
              checkHeader();
            });
            
            
            // HIDES THE LOADING SPINNER
            $(document).on('pjax:complete', function() {
              $('#loading').hide();
              $('#container').fadeIn(100);
              
              $('input#id_char').select();
              
              
              
            });
            
            // MAKES SURE THE HOME PAGE LOADS PROPERLY WITH BACK/FORWARDS CLICKS
            window.onpopstate = function(event) {   
            	checkHeader();
        	}
            
            /// BIND VARIOUS LINK TO PJAX
            $(document).pjax('a, a[data-pjax]', '#container');
            
            
            
            /// HELPS AVOID FREQUENT ABORTS CAUSED BY PJAX'S LOW DEFAULT TIMEOUT
            $(document).on('pjax:timeout', function(event) {
              // Prevent default timeout redirection behavior
              event.preventDefault()
            })

            function clearInput() {		
            	$('.clearMeFocus').each( function() {
            	   if ($(this).val() == '') {
            	      var id = $(this).attr('id');
            	      $('label[for="'+id+'"]').show();
            	   }
            	});
            	
            	$('.clearMeFocus').focus(function() {	
            		var id = $(this).attr('id');
            		$('label[for="'+id+'"]').addClass('focus');
            	});
            	
            	// if field is empty afterward, add text again
            	$('.clearMeFocus').blur(function() {
            		var id = $(this).attr('id');
            		
            		if($(this).val()=='') {
            			$('label[for="'+id+'"]').removeClass('focus');
            		}
            	}); 
            	
            	$('.clearMeFocus').keyup( function() {
            	    var id = $(this).attr('id');
            	    if ($(this).val() != '') {
            		  $('label[for="'+id+'"]').hide();
            	    } else {
            	      $('label[for="'+id+'"]').show();
            	    }
            	});  
            }           
		});
		
	</script>
    {% block extrajs %}{% endblock %}	

</body>

</html>
